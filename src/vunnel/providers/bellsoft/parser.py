from __future__ import annotations

import logging
import os
from typing import TYPE_CHECKING, Any

import orjson

if TYPE_CHECKING:
    from collections.abc import Generator

    from vunnel.workspace import Workspace

from .git import GitWrapper


class Parser:
    _git_src_url_ = "https://github.com/bell-sw/osv-database.git"
    _git_src_branch_ = "master"

    def __init__(self, ws: Workspace, logger: logging.Logger | None = None, versions: list[str] | None = None):
        if versions is None:
            versions = ["stream", "23", "25"]
        self.versions = versions
        self.workspace = ws
        self.git_url = self._git_src_url_
        self.git_branch = self._git_src_branch_
        self.urls = [self.git_url]
        if not logger:
            logger = logging.getLogger(self.__class__.__name__)
        self.logger = logger
        _checkout_dst_ = os.path.join(self.workspace.input_path, "osv-database")
        self.git_wrapper = GitWrapper(
            source=self.git_url,
            branch=self.git_branch,
            checkout_dest=_checkout_dst_,
            logger=self.logger,
        )

    def _load(self, version: str) -> Generator[dict[str, Any], None, None]:
        self.logger.info("loading data from git repository")

        vuln_data_dir = os.path.join(self.workspace.input_path, "osv-database", "BELL-CVE")
        for root, dirs, files in os.walk(vuln_data_dir):
            dirs.sort()
            for file in sorted(files):
                full_path = os.path.join(root, file)
                with open(full_path, encoding="utf-8") as f:
                    yield orjson.loads(f.read())

    def _normalize(self, vuln_entry: dict[str, Any], version: str) -> tuple[str, str, dict[str, Any]]:
        # We want to return the OSV record as it is (using OSV schema)
        # We'll transform it into the Grype-specific vulnerability schema
        # on grype-db
        vuln_id = vuln_entry["id"]
        vuln_schema = vuln_entry.get("schema_version", "1.7.4")  # TODO: this is a bit of a hack;

        return vuln_id, vuln_schema, vuln_entry

    def get(self) -> Generator[tuple[str, str, dict[str, Any]], None, None]:
        # Initialize the git repository
        self.git_wrapper.delete_repo()
        self.git_wrapper.clone_repo()
        for version in self.versions:
            for vuln_entry in self._load(version):
                if "withdrawn" in vuln_entry:
                    self.logger.debug("skipping withdrawn entry: "+vuln_entry["id"])
                elif "severity" in vuln_entry and vuln_entry["severity"][0]["type"] == "CVSS_V2":
                    self.logger.debug("skipping CVSS_V2 entry: "+vuln_entry["id"])
                else:
                    # Normalize the loaded data
                    yield self._normalize(vuln_entry, version)
